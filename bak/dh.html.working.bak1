<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECDH Key Exchange</title>
    <script src="https://cdn.jsdelivr.net/npm/bip39@3.0.4/dist/bip39.min.js"></script>
    <style>
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: Arial, sans-serif;
            transition: background-color 0.3s, color 0.3s;
            max-width: 600px;
            margin: auto;
            padding: 20px;
        }
        .light-mode {
            background-color: #ffffff;
            color: #000000;
        }
        textarea, input {
            width: 100%;
            font-size: 1rem;
            margin-bottom: 10px;
            padding: 8px;
        }
        .password-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        .password-container input {
            flex-grow: 1;
            padding-right: 40px;
            height: 80px;
            font-size: 1rem;
        }
        .toggle-password {
            position: absolute;
            right: 10px;
            cursor: pointer;
            font-size: 1.2rem;
        }
        button {
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <button onclick="toggleTheme()">Toggle Dark/Light Mode</button>
    
    <h2>ECDH Key Exchange</h2>
    
    <button onclick="generateKeys()">Generate Keypair</button>
    
    <h3>Your Public Key</h3>
    <textarea id="publicKeyBase64" rows="2" readonly></textarea>

    <h3>Your Private Key</h3>
    <div class="password-container">
        <input type="password" id="privateKeyBase64" readonly>
        <span class="toggle-password" onclick="togglePasswordVisibility()">üëÅ</span>
    </div>

    <h3>Enter Partner's Public Key</h3>
    <textarea id="partnerKeyBase64" rows="2"></textarea>
    
    <button onclick="deriveSharedSecret()">Compute Shared Secret</button>
    
    <h3>Shared Secret</h3>
    <textarea id="sharedSecretBase64" rows="2" readonly></textarea>

    <script>
        let privateKey, publicKey;

        function toggleTheme() {
            document.body.classList.toggle("light-mode");
        }

        async function generateKeys() {
            const keyPair = await window.crypto.subtle.generateKey(
                { name: "ECDH", namedCurve: "P-256" },
                true, ["deriveKey", "deriveBits"]
            );

            privateKey = keyPair.privateKey;
            publicKey = keyPair.publicKey;

            const exportedPubKey = await window.crypto.subtle.exportKey("spki", publicKey);
            const exportedPrivKey = await window.crypto.subtle.exportKey("pkcs8", privateKey);

            document.getElementById("publicKeyBase64").value = btoa(String.fromCharCode(...new Uint8Array(exportedPubKey)));
            document.getElementById("privateKeyBase64").value = btoa(String.fromCharCode(...new Uint8Array(exportedPrivKey)));
        }

        async function deriveSharedSecret() {
            if (!privateKey) {
                alert("Generate your keypair first!");
                return;
            }

            const partnerKeyBase64 = document.getElementById("partnerKeyBase64").value.trim();
            if (!partnerKeyBase64) {
                alert("Enter a valid partner public key!");
                return;
            }

            try {
                const partnerKeyArray = Uint8Array.from(atob(partnerKeyBase64), c => c.charCodeAt(0));
                const partnerKey = await window.crypto.subtle.importKey(
                    "spki", partnerKeyArray,
                    { name: "ECDH", namedCurve: "P-256" },
                    false, []
                );

                let sharedSecret = await window.crypto.subtle.deriveBits(
                    { name: "ECDH", public: partnerKey },
                    privateKey,
                    256
                );

                // Hash the shared secret
                sharedSecret = await window.crypto.subtle.digest("SHA-256", sharedSecret);
                
                document.getElementById("sharedSecretBase64").value = btoa(String.fromCharCode(...new Uint8Array(sharedSecret)));
            } catch (error) {
                alert("Invalid partner public key format!");
            }
        }

        function togglePasswordVisibility() {
            const passwordField = document.getElementById("privateKeyBase64");
            passwordField.type = passwordField.type === "password" ? "text" : "password";
        }
    </script>
</body>
</html>
